name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

permissions:
  actions: read
  contents: read
  security-events: write

env:
  DOTNET_VERSION: '8.0.x'
  
jobs:
  lint-and-format:
    name: ğŸ” Code Quality & Formatting
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore AzureDriftDetector.csproj
      
    - name: ğŸ”§ Build project
      run: dotnet build AzureDriftDetector.csproj --no-restore --configuration Release
      
    - name: ğŸ¯ Check code formatting
      run: dotnet format AzureDriftDetector.csproj --verify-no-changes --verbosity diagnostic
      continue-on-error: true # Don't fail on formatting issues for now
      
    - name: ğŸ“‹ Run code analysis
      run: dotnet build AzureDriftDetector.csproj --configuration Release --verbosity normal
      
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore AzureDriftDetector.csproj
      
    - name: ğŸ”§ Build project
      run: dotnet build AzureDriftDetector.csproj --no-restore --configuration Release
      
    - name: âœ… Build Status
      run: echo "ğŸ‰ Build successful on ${{ matrix.os }}!"
        
  security-analysis:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    continue-on-error: true # Don't fail the entire workflow if CodeQL setup isn't complete
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ” Run security analysis
      run: |
        dotnet list AzureDriftDetector.csproj package --vulnerable --include-transitive || true
        dotnet list AzureDriftDetector.csproj package --deprecated || true
        
    - name: ğŸ›¡ï¸ Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: csharp
      continue-on-error: true
        
    - name: ğŸ“¦ Restore dependencies for analysis
      run: dotnet restore AzureDriftDetector.csproj
        
    - name: ğŸ”§ Build for analysis
      run: dotnet build AzureDriftDetector.csproj --configuration Release --no-restore
      
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:csharp"
      continue-on-error: true
      
  validate-bicep:
    name: ğŸ”§ Validate Bicep Templates
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az version
        
    - name: ğŸ”§ Install Bicep CLI
      run: az bicep install
      
    - name: âœ… Validate Bicep templates
      run: |
        echo "ğŸ” Validating Bicep templates..."
        for file in *.bicep; do
          if [[ -f "$file" ]]; then
            echo "Validating $file..."
            az bicep build --file "$file" --stdout > /dev/null
            echo "âœ… $file is valid"
          fi
        done
        
  create-release-artifacts:
    name: ğŸ“¦ Create Release Artifacts
    runs-on: ubuntu-latest
    needs: [lint-and-format, build-and-test, security-analysis]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      actions: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore AzureDriftDetector.csproj
      
    - name: ğŸ—ï¸ Build for multiple platforms
      run: |
        # Build for Windows x64
        dotnet publish AzureDriftDetector.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./artifacts/win-x64
        
        # Build for Linux x64
        dotnet publish AzureDriftDetector.csproj -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o ./artifacts/linux-x64
        
        # Build for macOS x64
        dotnet publish AzureDriftDetector.csproj -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true -o ./artifacts/osx-x64
        
    - name: ğŸ“‹ Create build info
      run: |
        echo "Build Information" > ./artifacts/BUILD_INFO.txt
        echo "=================" >> ./artifacts/BUILD_INFO.txt
        echo "Build Date: $(date)" >> ./artifacts/BUILD_INFO.txt
        echo "Commit SHA: ${{ github.sha }}" >> ./artifacts/BUILD_INFO.txt
        echo "Branch: ${{ github.ref_name }}" >> ./artifacts/BUILD_INFO.txt
        echo ".NET Version: ${{ env.DOTNET_VERSION }}" >> ./artifacts/BUILD_INFO.txt
        
    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts
        path: ./artifacts/
        retention-days: 90
        
  report-status:
    name: ğŸ“Š Build Status Report
    runs-on: ubuntu-latest
    needs: [lint-and-format, build-and-test, security-analysis, validate-bicep]
    if: always()
    
    steps:
    - name: ğŸ“Š Report Success
      if: needs.lint-and-format.result == 'success' && needs.build-and-test.result == 'success' && needs.security-analysis.result == 'success' && needs.validate-bicep.result == 'success'
      run: |
        echo "âœ… All quality checks passed!"
        echo "ğŸ‰ Azure Configuration Drift Detector is ready for deployment!"
        
    - name: âŒ Report Failure
      if: needs.lint-and-format.result == 'failure' || needs.build-and-test.result == 'failure' || needs.security-analysis.result == 'failure' || needs.validate-bicep.result == 'failure'
      run: |
        echo "âŒ Some quality checks failed:"
        echo "Lint & Format: ${{ needs.lint-and-format.result }}"
        echo "Build & Test: ${{ needs.build-and-test.result }}"  
        echo "Security Analysis: ${{ needs.security-analysis.result }}"
        echo "Bicep Validation: ${{ needs.validate-bicep.result }}"
        exit 1