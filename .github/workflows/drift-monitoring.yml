name: ðŸ” Azure Drift Monitoring

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

permissions:
  contents: read
  issues: write
  id-token: write  # Required for OIDC authentication

jobs:
  monitor-drift:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: 
          - { name: 'dev', resource_group: 'dev' }
          - { name: 'staging', resource_group: 'staging' }
          - { name: 'prod', resource_group: 'production' }
      fail-fast: false
      
    name: Monitor ${{ matrix.environment.name }}
    
    steps:
    - uses: actions/checkout@v5
      
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ vars.AZURE_CLIENT_ID }}
        tenant-id: ${{ vars.AZURE_TENANT_ID }}
        subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

    - name: Download Drift Detector
      run: |
        curl -L -o detector https://github.com/mwhooo/AzureDriftDetector/releases/latest/download/AzureDriftDetector-linux-x64
        chmod +x detector

    - name: Check Drift
      id: check
      continue-on-error: true
      run: |
        if ./detector --bicep-file complex-template.bicep --resource-group ${{ matrix.environment.resource_group }} --simple-output; then
          echo "drift=false" >> $GITHUB_OUTPUT
        else
          echo "drift=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Issue on Drift
      if: steps.check.outputs.drift == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const env = '${{ matrix.environment.name }}';
          const title = `ðŸš¨ Drift Detected in ${env.toUpperCase()}`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: `Configuration drift detected in ${env} environment.\\nRun: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            labels: ['drift-alert', env]
          });