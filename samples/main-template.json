{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "12188202840373905004"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Common parameters"
      }
    },
    "environmentName": {
      "type": "string"
    },
    "applicationName": {
      "type": "string"
    },
    "storageConfig": {
      "type": "object",
      "metadata": {
        "description": "Storage account configuration"
      }
    },
    "vnetConfig": {
      "type": "object",
      "metadata": {
        "description": "Virtual network configuration"
      }
    },
    "nsgConfig": {
      "type": "object",
      "metadata": {
        "description": "Network security group configuration"
      }
    },
    "appServicePlanConfig": {
      "type": "object",
      "metadata": {
        "description": "App Service Plan configuration"
      }
    },
    "logAnalyticsConfig": {
      "type": "object",
      "nullable": true,
      "metadata": {
        "description": "Log Analytics Workspace configuration"
      }
    },
    "keyVaultConfig": {
      "type": "object",
      "nullable": true,
      "metadata": {
        "description": "Key Vault configuration"
      }
    },
    "serviceBusConfig": {
      "type": "object",
      "nullable": true,
      "metadata": {
        "description": "Service Bus configuration"
      }
    },
    "tags": {
      "type": "object",
      "metadata": {
        "description": "Common resource tags"
      }
    },
    "deployVnet": {
      "type": "bool",
      "metadata": {
        "description": "Deployment switches"
      }
    },
    "deployNsg": {
      "type": "bool"
    },
    "deployStorage": {
      "type": "bool"
    },
    "deployAppServicePlan": {
      "type": "bool"
    },
    "deployLogAnalytics": {
      "type": "bool"
    },
    "deployKeyVault": {
      "type": "bool"
    },
    "deployServiceBus": {
      "type": "bool"
    }
  },
  "variables": {
    "uniqueSuffix": "[take(uniqueString(resourceGroup().id), 8)]",
    "vnetConfigWithCommon": "[union(parameters('vnetConfig'), createObject('location', parameters('location'), 'tags', parameters('tags')))]",
    "nsgConfigWithCommon": "[union(parameters('nsgConfig'), createObject('location', parameters('location'), 'tags', parameters('tags')))]",
    "storageConfigWithCommon": "[union(parameters('storageConfig'), createObject('location', parameters('location'), 'tags', parameters('tags'), 'storageAccountName', format('{0}{1}', parameters('storageConfig').storageAccountName, variables('uniqueSuffix'))))]",
    "appServicePlanConfigWithCommon": "[union(parameters('appServicePlanConfig'), createObject('location', parameters('location'), 'tags', parameters('tags')))]",
    "logAnalyticsConfigWithCommon": "[if(not(equals(parameters('logAnalyticsConfig'), null())), union(parameters('logAnalyticsConfig'), createObject('location', parameters('location'), 'tags', parameters('tags'), 'name', format('{0}-{1}', parameters('logAnalyticsConfig').name, variables('uniqueSuffix')))), null())]",
    "keyVaultConfigWithCommon": "[if(not(equals(parameters('keyVaultConfig'), null())), union(parameters('keyVaultConfig'), createObject('location', parameters('location'), 'tags', parameters('tags'), 'name', format('{0}{1}', parameters('keyVaultConfig').name, variables('uniqueSuffix')))), null())]",
    "serviceBusConfigWithCommon": "[if(not(equals(parameters('serviceBusConfig'), null())), union(parameters('serviceBusConfig'), createObject('location', parameters('location'), 'tags', parameters('tags'), 'name', format('{0}{1}', parameters('serviceBusConfig').name, variables('uniqueSuffix')))), null())]"
  },
  "resources": {
    "vnetModule": {
      "condition": "[parameters('deployVnet')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "vnet-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnetConfig": {
            "value": "[variables('vnetConfigWithCommon')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1171659666513820870"
            }
          },
          "definitions": {
            "EnableState": {
              "type": "string",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "Subnet": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Name of the subnet"
                  }
                },
                "addressPrefix": {
                  "type": "string",
                  "metadata": {
                    "description": "Address prefix for the subnet"
                  }
                },
                "privateEndpointNetworkPolicies": {
                  "$ref": "#/definitions/EnableState",
                  "nullable": true,
                  "metadata": {
                    "description": "Private endpoint network policies"
                  }
                },
                "privateLinkServiceNetworkPolicies": {
                  "$ref": "#/definitions/EnableState",
                  "nullable": true,
                  "metadata": {
                    "description": "Private link service network policies"
                  }
                },
                "networkSecurityGroupId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Network security group resource ID"
                  }
                },
                "routeTableId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Route table resource ID"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "VnetConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Virtual network name"
                  }
                },
                "location": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Location for the virtual network"
                  }
                },
                "addressSpaces": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Address space for the virtual network"
                  }
                },
                "subnets": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/Subnet"
                  },
                  "metadata": {
                    "description": "Subnets configuration"
                  }
                },
                "enableDdosProtection": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable DDoS protection"
                  }
                },
                "ddosProtectionPlanId": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "DDoS protection plan resource ID (required if enableDdosProtection is true)"
                  }
                },
                "tags": {
                  "type": "object",
                  "nullable": true,
                  "metadata": {
                    "description": "Tags for the virtual network"
                  }
                },
                "dnsServers": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "DNS servers for the virtual network"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "vnetConfig": {
              "$ref": "#/definitions/VnetConfig",
              "metadata": {
                "description": "Virtual network configuration"
              }
            }
          },
          "resources": {
            "virtualNetwork": {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-04-01",
              "name": "[parameters('vnetConfig').name]",
              "location": "[coalesce(tryGet(parameters('vnetConfig'), 'location'), resourceGroup().location)]",
              "tags": "[coalesce(tryGet(parameters('vnetConfig'), 'tags'), createObject())]",
              "properties": {
                "copy": [
                  {
                    "name": "subnets",
                    "count": "[length(parameters('vnetConfig').subnets)]",
                    "input": {
                      "name": "[parameters('vnetConfig').subnets[copyIndex('subnets')].name]",
                      "properties": {
                        "addressPrefix": "[parameters('vnetConfig').subnets[copyIndex('subnets')].addressPrefix]",
                        "privateEndpointNetworkPolicies": "[coalesce(tryGet(parameters('vnetConfig').subnets[copyIndex('subnets')], 'privateEndpointNetworkPolicies'), 'Enabled')]",
                        "privateLinkServiceNetworkPolicies": "[coalesce(tryGet(parameters('vnetConfig').subnets[copyIndex('subnets')], 'privateLinkServiceNetworkPolicies'), 'Enabled')]",
                        "networkSecurityGroup": "[if(not(empty(coalesce(tryGet(parameters('vnetConfig').subnets[copyIndex('subnets')], 'networkSecurityGroupId'), ''))), createObject('id', tryGet(parameters('vnetConfig').subnets[copyIndex('subnets')], 'networkSecurityGroupId')), null())]",
                        "routeTable": "[if(not(empty(coalesce(tryGet(parameters('vnetConfig').subnets[copyIndex('subnets')], 'routeTableId'), ''))), createObject('id', tryGet(parameters('vnetConfig').subnets[copyIndex('subnets')], 'routeTableId')), null())]"
                      }
                    }
                  }
                ],
                "addressSpace": {
                  "addressPrefixes": "[coalesce(tryGet(parameters('vnetConfig'), 'addressSpaces'), createArray('10.0.0.0/16'))]"
                },
                "dhcpOptions": "[if(not(empty(coalesce(tryGet(parameters('vnetConfig'), 'dnsServers'), createArray()))), createObject('dnsServers', tryGet(parameters('vnetConfig'), 'dnsServers')), null())]",
                "enableDdosProtection": "[coalesce(tryGet(parameters('vnetConfig'), 'enableDdosProtection'), false())]",
                "ddosProtectionPlan": "[if(and(coalesce(tryGet(parameters('vnetConfig'), 'enableDdosProtection'), false()), not(empty(coalesce(tryGet(parameters('vnetConfig'), 'ddosProtectionPlanId'), '')))), createObject('id', tryGet(parameters('vnetConfig'), 'ddosProtectionPlanId')), null())]"
              }
            }
          },
          "outputs": {
            "vnetId": {
              "type": "string",
              "metadata": {
                "description": "Virtual network resource ID"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetConfig').name)]"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Virtual network name"
              },
              "value": "[parameters('vnetConfig').name]"
            },
            "addressSpaces": {
              "type": "array",
              "metadata": {
                "description": "Virtual network address space"
              },
              "value": "[reference('virtualNetwork').addressSpace.addressPrefixes]"
            },
            "subnets": {
              "type": "array",
              "metadata": {
                "description": "Subnet details"
              },
              "copy": {
                "count": "[length(parameters('vnetConfig').subnets)]",
                "input": {
                  "name": "[reference('virtualNetwork').subnets[copyIndex()].name]",
                  "id": "[reference('virtualNetwork').subnets[copyIndex()].id]",
                  "addressPrefix": "[reference('virtualNetwork').subnets[copyIndex()].properties.addressPrefix]"
                }
              }
            }
          }
        }
      }
    },
    "nsgModule": {
      "condition": "[parameters('deployNsg')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "nsg-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "nsgConfig": {
            "value": "[variables('nsgConfigWithCommon')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9819415396877216900"
            }
          },
          "definitions": {
            "AccessType": {
              "type": "string",
              "allowedValues": [
                "Allow",
                "Deny"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "TrafficDirection": {
              "type": "string",
              "allowedValues": [
                "Inbound",
                "Outbound"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "NetworkProtocol": {
              "type": "string",
              "allowedValues": [
                "*",
                "Icmp",
                "Tcp",
                "Udp"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "SecurityRule": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Name of the security rule"
                  }
                },
                "priority": {
                  "type": "int",
                  "minValue": 100,
                  "maxValue": 4096,
                  "metadata": {
                    "description": "Priority of the rule"
                  }
                },
                "access": {
                  "$ref": "#/definitions/AccessType",
                  "metadata": {
                    "description": "Access type"
                  }
                },
                "direction": {
                  "$ref": "#/definitions/TrafficDirection",
                  "metadata": {
                    "description": "Direction of traffic"
                  }
                },
                "protocol": {
                  "$ref": "#/definitions/NetworkProtocol",
                  "metadata": {
                    "description": "Protocol"
                  }
                },
                "sourcePortRange": {
                  "type": "string",
                  "metadata": {
                    "description": "Source port range"
                  }
                },
                "destinationPortRange": {
                  "type": "string",
                  "metadata": {
                    "description": "Destination port range"
                  }
                },
                "sourceAddressPrefix": {
                  "type": "string",
                  "metadata": {
                    "description": "Source address prefix"
                  }
                },
                "destinationAddressPrefix": {
                  "type": "string",
                  "metadata": {
                    "description": "Destination address prefix"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "NsgConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Network Security Group name"
                  }
                },
                "location": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Location for the NSG"
                  }
                },
                "securityRules": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/SecurityRule"
                  },
                  "metadata": {
                    "description": "Security rules configuration"
                  }
                },
                "tags": {
                  "type": "object",
                  "nullable": true,
                  "metadata": {
                    "description": "Tags for the NSG"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "nsgConfig": {
              "$ref": "#/definitions/NsgConfig",
              "metadata": {
                "description": "Network Security Group configuration"
              }
            }
          },
          "resources": {
            "networkSecurityGroup": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-04-01",
              "name": "[parameters('nsgConfig').name]",
              "location": "[coalesce(tryGet(parameters('nsgConfig'), 'location'), resourceGroup().location)]",
              "properties": {
                "copy": [
                  {
                    "name": "securityRules",
                    "count": "[length(parameters('nsgConfig').securityRules)]",
                    "input": {
                      "name": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].name]",
                      "properties": {
                        "priority": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].priority]",
                        "access": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].access]",
                        "direction": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].direction]",
                        "protocol": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].protocol]",
                        "sourcePortRange": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].sourcePortRange]",
                        "destinationPortRange": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].destinationPortRange]",
                        "sourceAddressPrefix": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].sourceAddressPrefix]",
                        "destinationAddressPrefix": "[parameters('nsgConfig').securityRules[copyIndex('securityRules')].destinationAddressPrefix]"
                      }
                    }
                  }
                ]
              },
              "tags": "[coalesce(tryGet(parameters('nsgConfig'), 'tags'), createObject())]"
            }
          },
          "outputs": {
            "nsgId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgConfig').name)]"
            },
            "nsgName": {
              "type": "string",
              "value": "[parameters('nsgConfig').name]"
            }
          }
        }
      }
    },
    "storageModule": {
      "condition": "[parameters('deployStorage')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountConfig": {
            "value": "[variables('storageConfigWithCommon')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10685890064811945112"
            }
          },
          "definitions": {
            "StorageAccountSku": {
              "type": "string",
              "allowedValues": [
                "Premium_LRS",
                "Premium_ZRS",
                "Standard_GRS",
                "Standard_LRS",
                "Standard_RAGRS",
                "Standard_ZRS"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "StorageAccountKind": {
              "type": "string",
              "allowedValues": [
                "BlobStorage",
                "BlockBlobStorage",
                "FileStorage",
                "Storage",
                "StorageV2"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "AccessTier": {
              "type": "string",
              "allowedValues": [
                "Cool",
                "Hot"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "TlsVersion": {
              "type": "string",
              "allowedValues": [
                "TLS1_0",
                "TLS1_1",
                "TLS1_2"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "NetworkAction": {
              "type": "string",
              "allowedValues": [
                "Allow",
                "Deny"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "EnableState": {
              "type": "string",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "StorageAccountConfig": {
              "type": "object",
              "properties": {
                "storageAccountName": {
                  "type": "string",
                  "metadata": {
                    "description": "Name of the storage account"
                  }
                },
                "location": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Location for the storage account"
                  }
                },
                "skuName": {
                  "$ref": "#/definitions/StorageAccountSku",
                  "nullable": true,
                  "metadata": {
                    "description": "Storage account SKU"
                  }
                },
                "kind": {
                  "$ref": "#/definitions/StorageAccountKind",
                  "nullable": true,
                  "metadata": {
                    "description": "Storage account kind"
                  }
                },
                "accessTier": {
                  "$ref": "#/definitions/AccessTier",
                  "nullable": true,
                  "metadata": {
                    "description": "Storage account access tier"
                  }
                },
                "allowBlobPublicAccess": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Allow public access to blobs"
                  }
                },
                "allowSharedKeyAccess": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Allow shared key access"
                  }
                },
                "minimumTlsVersion": {
                  "$ref": "#/definitions/TlsVersion",
                  "nullable": true,
                  "metadata": {
                    "description": "Minimum TLS version"
                  }
                },
                "supportsHttpsTrafficOnly": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable HTTPS traffic only"
                  }
                },
                "networkAclsDefaultAction": {
                  "$ref": "#/definitions/NetworkAction",
                  "nullable": true,
                  "metadata": {
                    "description": "Network access configuration"
                  }
                },
                "virtualNetworkRules": {
                  "type": "array",
                  "nullable": true,
                  "metadata": {
                    "description": "Virtual network rules"
                  }
                },
                "ipRules": {
                  "type": "array",
                  "nullable": true,
                  "metadata": {
                    "description": "IP rules for firewall"
                  }
                },
                "tags": {
                  "type": "object",
                  "nullable": true,
                  "metadata": {
                    "description": "Tags for the storage account"
                  }
                },
                "isHnsEnabled": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable hierarchical namespace (Data Lake Gen2)"
                  }
                },
                "largeFileSharesState": {
                  "$ref": "#/definitions/EnableState",
                  "nullable": true,
                  "metadata": {
                    "description": "Large file shares state"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "storageAccountConfig": {
              "$ref": "#/definitions/StorageAccountConfig",
              "metadata": {
                "description": "Storage account configuration"
              }
            }
          },
          "resources": {
            "storageAccount": {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('storageAccountConfig').storageAccountName]",
              "location": "[coalesce(tryGet(parameters('storageAccountConfig'), 'location'), resourceGroup().location)]",
              "kind": "[coalesce(tryGet(parameters('storageAccountConfig'), 'kind'), 'StorageV2')]",
              "sku": {
                "name": "[coalesce(tryGet(parameters('storageAccountConfig'), 'skuName'), 'Standard_LRS')]"
              },
              "tags": "[coalesce(tryGet(parameters('storageAccountConfig'), 'tags'), createObject())]",
              "properties": {
                "accessTier": "[coalesce(tryGet(parameters('storageAccountConfig'), 'accessTier'), 'Hot')]",
                "allowBlobPublicAccess": "[coalesce(tryGet(parameters('storageAccountConfig'), 'allowBlobPublicAccess'), false())]",
                "allowSharedKeyAccess": "[coalesce(tryGet(parameters('storageAccountConfig'), 'allowSharedKeyAccess'), true())]",
                "minimumTlsVersion": "[coalesce(tryGet(parameters('storageAccountConfig'), 'minimumTlsVersion'), 'TLS1_2')]",
                "supportsHttpsTrafficOnly": "[coalesce(tryGet(parameters('storageAccountConfig'), 'supportsHttpsTrafficOnly'), true())]",
                "isHnsEnabled": "[coalesce(tryGet(parameters('storageAccountConfig'), 'isHnsEnabled'), false())]",
                "largeFileSharesState": "[coalesce(tryGet(parameters('storageAccountConfig'), 'largeFileSharesState'), 'Disabled')]",
                "networkAcls": {
                  "defaultAction": "[coalesce(tryGet(parameters('storageAccountConfig'), 'networkAclsDefaultAction'), 'Allow')]",
                  "virtualNetworkRules": "[coalesce(tryGet(parameters('storageAccountConfig'), 'virtualNetworkRules'), createArray())]",
                  "ipRules": "[coalesce(tryGet(parameters('storageAccountConfig'), 'ipRules'), createArray())]",
                  "bypass": "AzureServices"
                }
              }
            }
          },
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage account resource ID"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountConfig').storageAccountName)]"
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              },
              "value": "[parameters('storageAccountConfig').storageAccountName]"
            },
            "primaryBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage account primary blob endpoint"
              },
              "value": "[reference('storageAccount').primaryEndpoints.blob]"
            }
          }
        }
      }
    },
    "appServicePlanModule": {
      "condition": "[parameters('deployAppServicePlan')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "app-service-plan-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServicePlanConfig": {
            "value": "[variables('appServicePlanConfigWithCommon')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15347448570641430300"
            }
          },
          "definitions": {
            "AppServicePlanSku": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "SKU name (e.g., F1, B1, S1, P1v2)"
                  }
                },
                "tier": {
                  "type": "string",
                  "metadata": {
                    "description": "SKU tier (e.g., Free, Basic, Standard, Premium)"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "AppServicePlanConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "App Service Plan name"
                  }
                },
                "location": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Location for the App Service Plan"
                  }
                },
                "sku": {
                  "$ref": "#/definitions/AppServicePlanSku",
                  "metadata": {
                    "description": "SKU configuration for the App Service Plan"
                  }
                },
                "reserved": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Whether the App Service Plan is reserved (Linux)"
                  }
                },
                "zoneRedundant": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable zone redundancy"
                  }
                },
                "tags": {
                  "type": "object",
                  "nullable": true,
                  "metadata": {
                    "description": "Tags for the App Service Plan"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "appServicePlanConfig": {
              "$ref": "#/definitions/AppServicePlanConfig",
              "metadata": {
                "description": "App Service Plan configuration"
              }
            }
          },
          "resources": {
            "appServicePlan": {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServicePlanConfig').name]",
              "location": "[coalesce(tryGet(parameters('appServicePlanConfig'), 'location'), resourceGroup().location)]",
              "sku": "[parameters('appServicePlanConfig').sku]",
              "properties": {
                "reserved": "[coalesce(tryGet(parameters('appServicePlanConfig'), 'reserved'), false())]",
                "zoneRedundant": "[coalesce(tryGet(parameters('appServicePlanConfig'), 'zoneRedundant'), false())]"
              },
              "tags": "[coalesce(tryGet(parameters('appServicePlanConfig'), 'tags'), createObject())]"
            }
          },
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanConfig').name)]"
            },
            "appServicePlanName": {
              "type": "string",
              "value": "[parameters('appServicePlanConfig').name]"
            }
          }
        }
      }
    },
    "logAnalyticsModule": {
      "condition": "[and(parameters('deployLogAnalytics'), not(equals(parameters('logAnalyticsConfig'), null())))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "log-analytics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "logAnalyticsConfig": {
            "value": "[variables('logAnalyticsConfigWithCommon')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9638491463814574907"
            }
          },
          "definitions": {
            "LogAnalyticsSku": {
              "type": "string",
              "allowedValues": [
                "Free",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "LogAnalyticsConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Log Analytics Workspace name"
                  }
                },
                "location": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Location for the workspace"
                  }
                },
                "skuName": {
                  "$ref": "#/definitions/LogAnalyticsSku",
                  "nullable": true,
                  "metadata": {
                    "description": "SKU name"
                  }
                },
                "retentionInDays": {
                  "type": "int",
                  "nullable": true,
                  "minValue": 30,
                  "maxValue": 730,
                  "metadata": {
                    "description": "Data retention in days"
                  }
                },
                "enableLogAccessUsingOnlyResourcePermissions": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable log access using only resource permissions"
                  }
                },
                "tags": {
                  "type": "object",
                  "nullable": true,
                  "metadata": {
                    "description": "Tags for the workspace"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "logAnalyticsConfig": {
              "$ref": "#/definitions/LogAnalyticsConfig",
              "metadata": {
                "description": "Log Analytics Workspace configuration"
              }
            }
          },
          "resources": {
            "logAnalyticsWorkspace": {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('logAnalyticsConfig').name]",
              "location": "[coalesce(tryGet(parameters('logAnalyticsConfig'), 'location'), resourceGroup().location)]",
              "properties": {
                "sku": {
                  "name": "[coalesce(tryGet(parameters('logAnalyticsConfig'), 'skuName'), 'PerGB2018')]"
                },
                "retentionInDays": "[coalesce(tryGet(parameters('logAnalyticsConfig'), 'retentionInDays'), 30)]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": "[coalesce(tryGet(parameters('logAnalyticsConfig'), 'enableLogAccessUsingOnlyResourcePermissions'), true())]"
                }
              },
              "tags": "[coalesce(tryGet(parameters('logAnalyticsConfig'), 'tags'), createObject())]"
            }
          },
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsConfig').name)]"
            },
            "workspaceName": {
              "type": "string",
              "value": "[parameters('logAnalyticsConfig').name]"
            },
            "customerId": {
              "type": "string",
              "value": "[reference('logAnalyticsWorkspace').customerId]"
            }
          }
        }
      }
    },
    "keyVaultModule": {
      "condition": "[and(parameters('deployKeyVault'), not(equals(parameters('keyVaultConfig'), null())))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "key-vault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultConfig": {
            "value": "[variables('keyVaultConfigWithCommon')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "6985757085383599710"
            }
          },
          "definitions": {
            "KeyVaultSkuFamily": {
              "type": "string",
              "allowedValues": [
                "A"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "KeyVaultSkuName": {
              "type": "string",
              "allowedValues": [
                "premium",
                "standard"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "PublicAccess": {
              "type": "string",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "KeyVaultSku": {
              "type": "object",
              "properties": {
                "family": {
                  "$ref": "#/definitions/KeyVaultSkuFamily",
                  "metadata": {
                    "description": "SKU family"
                  }
                },
                "name": {
                  "$ref": "#/definitions/KeyVaultSkuName",
                  "metadata": {
                    "description": "SKU name"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "KeyVaultConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Key Vault name"
                  }
                },
                "location": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Location for the Key Vault"
                  }
                },
                "sku": {
                  "$ref": "#/definitions/KeyVaultSku",
                  "metadata": {
                    "description": "SKU configuration"
                  }
                },
                "enabledForDeployment": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable for deployment"
                  }
                },
                "enabledForTemplateDeployment": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable for template deployment"
                  }
                },
                "enabledForDiskEncryption": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable for disk encryption"
                  }
                },
                "enableRbacAuthorization": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Enable RBAC authorization"
                  }
                },
                "publicNetworkAccess": {
                  "$ref": "#/definitions/PublicAccess",
                  "nullable": true,
                  "metadata": {
                    "description": "Public network access"
                  }
                },
                "tags": {
                  "type": "object",
                  "nullable": true,
                  "metadata": {
                    "description": "Tags for the Key Vault"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "keyVaultConfig": {
              "$ref": "#/definitions/KeyVaultConfig",
              "metadata": {
                "description": "Key Vault configuration"
              }
            }
          },
          "resources": {
            "keyVault": {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultConfig').name]",
              "location": "[coalesce(tryGet(parameters('keyVaultConfig'), 'location'), resourceGroup().location)]",
              "properties": {
                "sku": "[parameters('keyVaultConfig').sku]",
                "tenantId": "[subscription().tenantId]",
                "enabledForDeployment": "[coalesce(tryGet(parameters('keyVaultConfig'), 'enabledForDeployment'), false())]",
                "enabledForTemplateDeployment": "[coalesce(tryGet(parameters('keyVaultConfig'), 'enabledForTemplateDeployment'), false())]",
                "enabledForDiskEncryption": "[coalesce(tryGet(parameters('keyVaultConfig'), 'enabledForDiskEncryption'), false())]",
                "enableRbacAuthorization": "[coalesce(tryGet(parameters('keyVaultConfig'), 'enableRbacAuthorization'), true())]",
                "publicNetworkAccess": "[coalesce(tryGet(parameters('keyVaultConfig'), 'publicNetworkAccess'), 'Enabled')]"
              },
              "tags": "[coalesce(tryGet(parameters('keyVaultConfig'), 'tags'), createObject())]"
            }
          },
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultConfig').name)]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('keyVaultConfig').name]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference('keyVault').vaultUri]"
            }
          }
        }
      }
    },
    "serviceBusModule": {
      "condition": "[and(parameters('deployServiceBus'), not(equals(parameters('serviceBusConfig'), null())))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "service-bus-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "serviceBusConfig": {
            "value": "[variables('serviceBusConfigWithCommon')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17502240329527951578"
            }
          },
          "definitions": {
            "ServiceBusSku": {
              "type": "string",
              "allowedValues": [
                "Basic",
                "Premium",
                "Standard"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "TlsVersion": {
              "type": "string",
              "allowedValues": [
                "1.0",
                "1.1",
                "1.2"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "PublicNetworkAccess": {
              "type": "string",
              "allowedValues": [
                "Disabled",
                "Enabled"
              ],
              "metadata": {
                "__bicep_export!": true
              }
            },
            "QueueConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Queue name"
                  }
                },
                "maxDeliveryCount": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Maximum delivery count"
                  }
                },
                "lockDuration": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Lock duration (ISO 8601 duration format)"
                  }
                },
                "requiresDuplicateDetection": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Requires duplicate detection"
                  }
                },
                "requiresSession": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Requires session"
                  }
                },
                "deadLetteringOnMessageExpiration": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Dead lettering on message expiration"
                  }
                },
                "autoDeleteOnIdle": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Auto delete on idle (ISO 8601 duration format)"
                  }
                },
                "defaultMessageTimeToLive": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Default message time to live (ISO 8601 duration format)"
                  }
                },
                "duplicateDetectionHistoryTimeWindow": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Duplicate detection history time window (ISO 8601 duration format)"
                  }
                },
                "maxMessageSizeInKilobytes": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Maximum message size in kilobytes"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "SubscriptionConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Subscription name"
                  }
                },
                "maxDeliveryCount": {
                  "type": "int",
                  "nullable": true,
                  "metadata": {
                    "description": "Maximum delivery count"
                  }
                },
                "lockDuration": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Lock duration (ISO 8601 duration format)"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "TopicConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Topic name"
                  }
                },
                "subscriptions": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/SubscriptionConfig"
                  },
                  "metadata": {
                    "description": "Topic subscriptions"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            },
            "ServiceBusConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Service Bus namespace name"
                  }
                },
                "location": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Location for the Service Bus namespace"
                  }
                },
                "skuName": {
                  "$ref": "#/definitions/ServiceBusSku",
                  "nullable": true,
                  "metadata": {
                    "description": "Service Bus SKU"
                  }
                },
                "disableLocalAuth": {
                  "type": "bool",
                  "nullable": true,
                  "metadata": {
                    "description": "Disable local authentication"
                  }
                },
                "publicNetworkAccess": {
                  "$ref": "#/definitions/PublicNetworkAccess",
                  "nullable": true,
                  "metadata": {
                    "description": "Public network access"
                  }
                },
                "minimumTlsVersion": {
                  "$ref": "#/definitions/TlsVersion",
                  "nullable": true,
                  "metadata": {
                    "description": "Minimum TLS version"
                  }
                },
                "queues": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/QueueConfig"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Queues configuration"
                  }
                },
                "topics": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/TopicConfig"
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Topics configuration"
                  }
                },
                "tags": {
                  "type": "object",
                  "nullable": true,
                  "metadata": {
                    "description": "Tags for the Service Bus namespace"
                  }
                }
              },
              "metadata": {
                "__bicep_export!": true
              }
            }
          },
          "parameters": {
            "serviceBusConfig": {
              "$ref": "#/definitions/ServiceBusConfig",
              "metadata": {
                "description": "Service Bus configuration"
              }
            }
          },
          "resources": {
            "serviceBusNamespace": {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-10-01-preview",
              "name": "[parameters('serviceBusConfig').name]",
              "location": "[coalesce(tryGet(parameters('serviceBusConfig'), 'location'), resourceGroup().location)]",
              "tags": "[coalesce(tryGet(parameters('serviceBusConfig'), 'tags'), createObject())]",
              "sku": {
                "name": "[coalesce(tryGet(parameters('serviceBusConfig'), 'skuName'), 'Basic')]",
                "tier": "[coalesce(tryGet(parameters('serviceBusConfig'), 'skuName'), 'Basic')]"
              },
              "properties": {
                "disableLocalAuth": "[coalesce(tryGet(parameters('serviceBusConfig'), 'disableLocalAuth'), false())]",
                "publicNetworkAccess": "[coalesce(tryGet(parameters('serviceBusConfig'), 'publicNetworkAccess'), 'Enabled')]",
                "minimumTlsVersion": "[coalesce(tryGet(parameters('serviceBusConfig'), 'minimumTlsVersion'), '1.2')]",
                "zoneRedundant": false
              }
            },
            "queues": {
              "copy": {
                "name": "queues",
                "count": "[length(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray()))]"
              },
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusConfig').name, coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()].name)]",
              "properties": "[union(createObject('maxDeliveryCount', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'maxDeliveryCount'), 10), 'lockDuration', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'lockDuration'), 'PT1M'), 'requiresDuplicateDetection', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'requiresDuplicateDetection'), false()), 'requiresSession', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'requiresSession'), false()), 'deadLetteringOnMessageExpiration', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'deadLetteringOnMessageExpiration'), false()), 'maxSizeInMegabytes', 1024, 'enableBatchedOperations', true(), 'enablePartitioning', false()), if(not(equals(coalesce(tryGet(parameters('serviceBusConfig'), 'skuName'), 'Basic'), 'Basic')), createObject('autoDeleteOnIdle', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'autoDeleteOnIdle'), 'P10675199DT2H48M5.4775807S'), 'defaultMessageTimeToLive', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'defaultMessageTimeToLive'), 'P14D'), 'duplicateDetectionHistoryTimeWindow', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'duplicateDetectionHistoryTimeWindow'), 'PT10M'), 'maxMessageSizeInKilobytes', coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()], 'maxMessageSizeInKilobytes'), 256)), createObject()))]",
              "dependsOn": [
                "serviceBusNamespace"
              ]
            },
            "topics": {
              "copy": {
                "name": "topics",
                "count": "[length(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray()))]"
              },
              "type": "Microsoft.ServiceBus/namespaces/topics",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusConfig').name, coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].name)]",
              "properties": {
                "maxSizeInMegabytes": 1024,
                "enableBatchedOperations": true,
                "enablePartitioning": false
              },
              "dependsOn": [
                "serviceBusNamespace"
              ]
            },
            "subscriptions": {
              "copy": {
                "name": "subscriptions",
                "count": "[length(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray()))]"
              },
              "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('serviceBusConfig').name, coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].name, coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].subscriptions[0].name)]",
              "properties": {
                "maxDeliveryCount": "[coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].subscriptions[0], 'maxDeliveryCount'), 10)]",
                "lockDuration": "[coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].subscriptions[0], 'lockDuration'), 'PT1M')]",
                "deadLetteringOnMessageExpiration": true,
                "enableBatchedOperations": true
              },
              "dependsOn": [
                "[format('topics[{0}]', copyIndex())]"
              ]
            },
            "additionalSubscriptions": {
              "copy": {
                "name": "additionalSubscriptions",
                "count": "[length(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray()))]"
              },
              "condition": "[greater(length(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].subscriptions), 1)]",
              "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('serviceBusConfig').name, coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].name, coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].subscriptions[1].name)]",
              "properties": {
                "maxDeliveryCount": "[coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].subscriptions[1], 'maxDeliveryCount'), 10)]",
                "lockDuration": "[coalesce(tryGet(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].subscriptions[1], 'lockDuration'), 'PT1M')]",
                "deadLetteringOnMessageExpiration": true,
                "enableBatchedOperations": true
              },
              "dependsOn": [
                "[format('topics[{0}]', copyIndex())]"
              ]
            }
          },
          "outputs": {
            "serviceBusNamespaceId": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace resource ID"
              },
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusConfig').name)]"
            },
            "serviceBusNamespaceName": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              },
              "value": "[parameters('serviceBusConfig').name]"
            },
            "serviceBusEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Service Bus endpoint"
              },
              "value": "[reference('serviceBusNamespace').serviceBusEndpoint]"
            },
            "queueNames": {
              "type": "array",
              "metadata": {
                "description": "Queue names"
              },
              "copy": {
                "count": "[length(coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray()))]",
                "input": "[coalesce(tryGet(parameters('serviceBusConfig'), 'queues'), createArray())[copyIndex()].name]"
              }
            },
            "topicNames": {
              "type": "array",
              "metadata": {
                "description": "Topic names"
              },
              "copy": {
                "count": "[length(coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray()))]",
                "input": "[coalesce(tryGet(parameters('serviceBusConfig'), 'topics'), createArray())[copyIndex()].name]"
              }
            }
          }
        }
      }
    }
  },
  "outputs": {
    "vnetId": {
      "type": "string",
      "value": "[if(parameters('deployVnet'), reference('vnetModule').outputs.vnetId.value, '')]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[if(parameters('deployStorage'), reference('storageModule').outputs.storageAccountName.value, '')]"
    },
    "appServicePlanId": {
      "type": "string",
      "value": "[if(parameters('deployAppServicePlan'), reference('appServicePlanModule').outputs.appServicePlanId.value, '')]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[if(and(parameters('deployLogAnalytics'), not(equals(parameters('logAnalyticsConfig'), null()))), reference('logAnalyticsModule').outputs.workspaceId.value, '')]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[if(and(parameters('deployKeyVault'), not(equals(parameters('keyVaultConfig'), null()))), reference('keyVaultModule').outputs.keyVaultName.value, '')]"
    },
    "serviceBusNamespaceName": {
      "type": "string",
      "value": "[if(and(parameters('deployServiceBus'), not(equals(parameters('serviceBusConfig'), null()))), reference('serviceBusModule').outputs.serviceBusNamespaceName.value, '')]"
    },
    "nsgId": {
      "type": "string",
      "value": "[if(parameters('deployNsg'), reference('nsgModule').outputs.nsgId.value, '')]"
    },
    "environmentName": {
      "type": "string",
      "value": "[parameters('environmentName')]"
    },
    "applicationName": {
      "type": "string",
      "value": "[parameters('applicationName')]"
    }
  }
}